REPARTITION_CATEGORIE ‚Äî CORRECTIF (v.16/09/2025)
=================================================

Objet
-----
Corriger et figer la r√®gle de redistribution √† la cl√¥ture d'un √©v√®nement de cat√©gorie.
Profil concern√©s : Investisseurs, Porteurs, VISUAL.
Cette version applique le sch√©ma **40 / 30 / 7 / 23** (au lieu de 40 / 30 / 23 / 7).

D√©finitions
-----------
- S : somme totale √† r√©partir au moment de la cl√¥ture (avant arrondis).

R√®gle globale de r√©partition (absolu de S)
------------------------------------------
- Investisseurs TOP 10 : **40 %** de S
- Porteurs TOP 10      : **30 %** de S
- Investisseurs 11‚Äì100 : **7 %**  de S (√©quipartition)
- VISUAL               : **23 %** de S

D√©tail TOP 10 (pourcentages absolus de S)
-----------------------------------------
- Investisseurs (40 %) r√©partis par rang approx. :
  [13.66, 6.83, 4.55, 3.41, 2.73, 2.28, 1.95, 1.71, 1.52, 1.37] %
- Porteurs (30 %) r√©partis par rang approx. :
  [10.24, 5.12, 3.41, 2.56, 2.05, 1.71, 1.46, 1.28, 1.14, 1.02] %

Investisseurs 11‚Äì100 (√©quipartition)
------------------------------------
- Si N investisseurs √©ligibles (rangs 11‚Äì100, uniques) :
  Part individuelle = floor((0.07 √ó S) / N).

Arrondis
--------
- Tous les paiements UTILISATEURS (investisseurs, porteurs) sont **arrondis √† l'euro inf√©rieur**.
- Les **restes (centimes/√©carts)** alimentent VISUAL (**int√©gr√©s aux 23 %** pour couvrir co√ªts Bunny.net et autres).

Profils & o√π ils gagnent
------------------------
- Porteurs     : parts **30 %** (TOP 10 porteurs) ; ventes directes de leurs visuels (articles = infoporteurs).
- Investisseurs: parts **40 %** (TOP 10) + **7 %** (rangs 11‚Äì100, √©quipartition) ; Golden Ticket (selon rangs).
- Visiteurs    : Visiteur du Mois = **2 500 VISUpoints**.
- Infoporteurs : **70 %** par vente d'article ; **pot 24h** (s'ils sont TOP 10 articles).
- Investi-lecteurs : **part du pot 24h** s'ils ont achet√© ‚â• 1 article du TOP 10 articles.
- VISUAL       : **23 %** sur √©v√®nement de cat√©gorie + **30 %** sur chaque vente d'article (infoporteurs) + restes d'arrondis.

Mini-formulaire "dev" (pseudocode TypeScript-like)
--------------------------------------------------
/**
 * Entr√©es :
 *   S_eur : number ‚Äî somme totale en euros (peut contenir des centimes).
 *   invTop10Ids[10], porteurTop10Ids[10] : tableaux tri√©s par rang (1 -> 10).
 *   inv11to100Ids : liste des investisseurs uniques class√©s 11‚Äì100.
 * Sorties :
 *   payouts : enregistrements de paiements par acteur.
 * R√®gles :
 *   - Calcul en CENTIMES pour la pr√©cision, conversion √† l'euro pour les utilisateurs par plancher.
 *   - Les restes (cents et √©carts li√©s au floor) sont ajout√©s √† VISUAL.
 */

const INV_TOP10_ABS = [0.1366, 0.0683, 0.0455, 0.0341, 0.0273, 0.0228, 0.0195, 0.0171, 0.0152, 0.0137]; // ‚âà 40 %
const PORT_TOP10_ABS = [0.1024, 0.0512, 0.0341, 0.0256, 0.0205, 0.0171, 0.0146, 0.0128, 0.0114, 0.0102]; // ‚âà 30 %

function distributeCategory(S_eur) {
  const S_cents = Math.round(S_eur * 100);

  // Bases en centimes
  const base_inv40_cents   = Math.floor(0.40 * S_cents);
  const base_port30_cents  = Math.floor(0.30 * S_cents);
  const base_inv7_cents    = Math.floor(0.07 * S_cents);
  const base_visual23_cents= Math.floor(0.23 * S_cents);

  let payouts_cents_sum_users = 0;
  const payouts = [];

  // Investisseurs TOP 10 (parts absolues de S)
  for (let i = 0; i < 10; i++) {
    const amount_cents = Math.floor(INV_TOP10_ABS[i] * S_cents);
    const amount_eur_floor = Math.floor(amount_cents / 100);
    payouts.push({ type: "investor_top10", rank: i+1, cents: amount_eur_floor * 100 });
    payouts_cents_sum_users += amount_eur_floor * 100;
  }

  // Porteurs TOP 10 (parts absolues de S)
  for (let i = 0; i < 10; i++) {
    const amount_cents = Math.floor(PORT_TOP10_ABS[i] * S_cents);
    const amount_eur_floor = Math.floor(amount_cents / 100);
    payouts.push({ type: "creator_top10", rank: i+1, cents: amount_eur_floor * 100 });
    payouts_cents_sum_users += amount_eur_floor * 100;
  }

  // Investisseurs 11‚Äì100 (√©quipartition sur 7 %)
  const N = inv11to100Ids.length;
  if (N > 0) {
    const part_each_cents = Math.floor(base_inv7_cents / N);
    const part_each_euro_floor = Math.floor(part_each_cents / 100) * 100; // plancher √† l'euro
    for (const id of inv11to100Ids) {
      payouts.push({ type: "investor_11_100", user: id, cents: part_each_euro_floor });
      payouts_cents_sum_users += part_each_euro_floor;
    }
  }

  // VISUAL : base 23 % + restes (centimes/√©carts)
  const visual_base_cents = base_visual23_cents;

  // Somme totale affect√©e (utilisateurs + base VISUAL)
  const allocated_cents = payouts_cents_sum_users + visual_base_cents;

  // Reste (toujours >= 0, ce sont les centimes/√©carts suite aux floors √† l'euro)
  const residual_cents = Math.max(0, S_cents - allocated_cents);

  const visual_total_cents = visual_base_cents + residual_cents;

  payouts.push({ type: "visual_platform", cents: visual_total_cents });

  return payouts;
}

=========================================================================
SYST√àME TOP10 ARTICLES - REDISTRIBUTION QUOTIDIENNE (60/40)
=========================================================================

Objet
-----
Syst√®me de classement et redistribution quotidien pour les **infoporteurs** et **investi-lecteurs**.
Profils concern√©s : Infoporteurs, Investi-lecteurs, VISUAL.
Ce syst√®me fonctionne **ind√©pendamment** des √©v√©nements de cat√©gorie (r√®gle 40/30/7/23).

Contexte et Objectif
--------------------
Renforcer l'engagement des **investi-lecteurs** √† explorer et acheter les articles des **infoporteurs**.
Double incitation √©conomique :
- **Cr√©ateurs** ‚Üí Motivation √† produire du contenu de qualit√© (60% du pot)
- **Investisseurs** ‚Üí Motivation √† d√©couvrir les talents t√¥t (40% du pot)

R√®gles de Base - Ventes Directes
--------------------------------
- **Prix articles** : 0,2 ‚Ç¨ √† 5 ‚Ç¨ max (fix√©s par infoporteurs)
- **Tranches investi-lecteurs** : 0,2 ‚Ç¨ √† 10 ‚Ç¨ max
- **Commission VISUAL** : **30%** de chaque vente
- **Revenus infoporteur** : **70%** de chaque vente

Exemple vente directe (Article √† 2,00 ‚Ç¨) :
‚îú‚îÄ‚îÄ 0,60 ‚Ç¨ ‚Üí VISUAL (30% commission plateforme)
‚îî‚îÄ‚îÄ 1,40 ‚Ç¨ ‚Üí Infoporteur (70% revenus directs)

Classement Quotidien (minuit CET)
---------------------------------
1. **Calcul du classement** : Articles class√©s 1-100 par volume de ventes nettes de la journ√©e
2. **TOP 10 infoporteurs** : Auteurs des articles rangs 1-10
3. **Pool de redistribution** : Sommes investies par investi-lecteurs ayant achet√© des articles rangs **11-100**
4. **Investi-lecteurs vainqueurs** : Tous ceux ayant achet√© ‚â•1 article du TOP 10 (rangs 1-10)

D√©finitions TOP10 Articles
--------------------------
- P : pot total de redistribution en euros (avant arrondis)
- P = Œ£(sommes investies par investi-lecteurs sur articles rangs 11-100 du jour J)

R√®gle Globale de Redistribution TOP10 (absolu de P)
---------------------------------------------------
- **TOP10 infoporteurs** : **60%** de P (√©quipartition entre les 10)
- **Investi-lecteurs vainqueurs** : **40%** de P (√©quipartition par investissement gagnant)
- **VISUAL** : 0% du pot P + restes d'arrondis

Distribution TOP10 Infoporteurs (60% de P)
------------------------------------------
- R√©partition **√©quipartie** entre les 10 infoporteurs TOP10
- Part individuelle = floor((0.60 √ó P) / 10) euros plancher
- Si 10 infoporteurs TOP10 ‚Üí chacun re√ßoit floor(0.06 √ó P) euros

Distribution Investi-lecteurs Vainqueurs (40% de P)
---------------------------------------------------
- R√©partition **√©quipartie** entre tous les investissements gagnants
- Si N investissements sur articles TOP10 ‚Üí chaque investissement re√ßoit floor((0.40 √ó P) / N) euros
- **Important** : Un m√™me investi-lecteur avec plusieurs achats TOP10 = plusieurs parts

Arrondis TOP10 Articles
-----------------------
- Tous les paiements aux **infoporteurs** et **investi-lecteurs** : **arrondis √† l'euro inf√©rieur**
- Les **restes (centimes)** alimentent VISUAL

Exemple Concret TOP10 Articles
------------------------------
**Situation du jour J** :
- Article "Guide IA" de Marie ‚Üí Rang 1 (TOP10)
- Article "Crypto 2025" de Paul ‚Üí Rang 1 (TOP10)
- Pierre a achet√© "Guide IA" √† 2‚Ç¨
- Sophie a achet√© "Guide IA" √† 3‚Ç¨ 
- Pool P = 50‚Ç¨ (sommes investi-lecteurs rangs 11-100)

**Distribution** :
```
üí∞ 50‚Ç¨ de redistribution :
‚îú‚îÄ‚îÄ 30‚Ç¨ (60%) ‚Üí Marie + Paul + 8 autres TOP10 infoporteurs = 3‚Ç¨ chacun
‚îî‚îÄ‚îÄ 20‚Ç¨ (40%) ‚Üí Pierre + Sophie (2 investissements gagnants) = 10‚Ç¨ chacun
```

Mini-formulaire TOP10 Articles (pseudocode TypeScript-like)
----------------------------------------------------------
/**
 * Entr√©es :
 *   P_eur : number ‚Äî pot total en euros (sommes investi-lecteurs rangs 11-100).
 *   top10InfoporteurIds[10] : infoporteurs TOP10 par rang de vente.
 *   winningInvestments[] : liste des investissements sur articles TOP10.
 * Sorties :
 *   payouts : enregistrements de paiements par acteur.
 * R√®gles :
 *   - Calcul en CENTIMES pour la pr√©cision.
 *   - √âquipartition stricte (pas de pond√©ration par rang).
 *   - Floor √† l'euro pour utilisateurs, restes ‚Üí VISUAL.
 */

function distributeTop10Articles(P_eur, top10InfoporteurIds, winningInvestments) {
  const P_cents = Math.round(P_eur * 100);
  
  // Bases en centimes
  const infoporteurs_pool_cents = Math.floor(0.60 * P_cents); // 60%
  const winners_pool_cents = Math.floor(0.40 * P_cents);      // 40%
  
  let payouts_cents_sum_users = 0;
  const payouts = [];
  
  // TOP10 Infoporteurs (60% √©quipartition)
  const nb_infoporteurs = top10InfoporteurIds.length; // Normalement 10
  if (nb_infoporteurs > 0) {
    const part_each_infoporteur_cents = Math.floor(infoporteurs_pool_cents / nb_infoporteurs);
    const part_each_infoporteur_euro_floor = Math.floor(part_each_infoporteur_cents / 100);
    
    for (const infoporteurId of top10InfoporteurIds) {
      const amount_cents = part_each_infoporteur_euro_floor * 100;
      payouts.push({ type: "top10_infoporteur", user: infoporteurId, cents: amount_cents });
      payouts_cents_sum_users += amount_cents;
    }
  }
  
  // Investi-lecteurs Vainqueurs (40% √©quipartition par investissement)
  const nb_winning_investments = winningInvestments.length;
  if (nb_winning_investments > 0) {
    const part_each_investment_cents = Math.floor(winners_pool_cents / nb_winning_investments);
    const part_each_investment_euro_floor = Math.floor(part_each_investment_cents / 100);
    
    for (const investment of winningInvestments) {
      const amount_cents = part_each_investment_euro_floor * 100;
      payouts.push({ type: "investilecteur_winner", user: investment.userId, cents: amount_cents });
      payouts_cents_sum_users += amount_cents;
    }
  }
  
  // VISUAL : restes d'arrondis uniquement (pas de commission sur le pot)
  const total_distributed_cents = payouts_cents_sum_users;
  const residual_cents = Math.max(0, P_cents - total_distributed_cents);
  
  if (residual_cents > 0) {
    payouts.push({ type: "visual_platform_residual", cents: residual_cents });
  }
  
  return payouts;
}

Timing et Automatisation TOP10
------------------------------
- **Fr√©quence** : Redistribution automatique **quotidienne √† minuit CET**
- **Processus** : Classement ‚Üí Calcul pot ‚Üí Distribution ‚Üí Virements Stripe
- **D√©lai virements** : **24h** apr√®s calcul (conformit√© bancaire)
- **Persistance** : Toutes les redistributions sont archiv√©es pour audit

Paiements et Conformit√© TOP10
-----------------------------
- **Plateforme** : Stripe Connect (virements automatiques)
- **KYC obligatoire** : V√©rification identit√© avant premier retrait
- **Seuils de retrait** :
  - Infoporteurs : 50‚Ç¨ minimum
  - Investi-lecteurs : 25‚Ç¨ minimum

Interaction avec Autres Syst√®mes
--------------------------------
Le syst√®me TOP10 Articles est **totalement ind√©pendant** :
- ‚ùå **N'affecte PAS** les √©v√©nements de cat√©gorie (40/30/7/23)
- ‚ùå **N'affecte PAS** les Live Shows (40/30/20/10)  
- ‚úÖ **Fonctionne EN PARALL√àLE** avec tous les autres syst√®mes VISUAL

R√©sum√© TOP10 Articles
--------------------
- ‚úÖ **Ventes directes** : VISUAL 30% / Infoporteur 70% (imm√©diat)
- ‚úÖ **TOP10 infoporteurs** : 60% du pot quotidien (√©quipartition)
- ‚úÖ **Investi-lecteurs vainqueurs** : 40% du pot quotidien (par investissement)
- ‚úÖ **Pot quotidien** : Constitu√© des sommes investi-lecteurs rangs 11-100
- ‚úÖ **Redistribution automatique** : Chaque minuit via Stripe Connect

Notes
-----
- Les tableaux de r√©partition TOP 10 sont aproximatifs (arrondis). Les √©carts infimes se retrouvent dans les restes ‚Üí VISUAL.
- Tous les montants vers√©s aux UTILISATEURS sont au minimum √† l'euro (pas de centimes c√¥t√© utilisateurs).
- Les transferts sont effectu√©s via Stripe Connect ; KYC requis pour retrait.

Historique
----------
- (16/09/2025) Correctif valid√© : **Investisseurs 11‚Äì100 = 7 % ; VISUAL = 23 %**.
- (16/09/2025) Ajout : **Syst√®me TOP10 Articles d√©taill√© (60/40)** avec pot quotidien et redistribution automatique.